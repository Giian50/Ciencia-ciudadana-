
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Ciencia Ciudadana</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial; margin: 0; padding: 0; }
    #map { height: 500px; }
    .section { padding: 20px; }
    iframe { width: 100%; max-width: 800px; height: 450px; display: block; margin: auto; }
    form { margin-top: 20px; }
    input, button { display: block; margin: 10px 0; padding: 8px; width: 300px; }
  </style>
</head>
<body>

  <div class="section">
    <h1>Ciencia Ciudadana: Avistamientos</h1>
    <p>Visualización de puntos de avistamiento de cetáceos en la Región de Magallanes.</p>
    <div id="map"></div>
  </div>

  <div class="section">
    <h2>Video Etiquetado</h2>
    <iframe src="https://drive.google.com/file/d/1X3GRKkGTFH878GbsoCmc8_OyqnlDqXDe/preview" allow="autoplay"></iframe>
  </div>

  <div class="section">
    <h2>¿Cómo se ingresan los datos?</h2>
    <p>
      El ingreso de datos se realiza mediante formularios digitales o registros de campo, donde los participantes anotan información clave como especie, ubicación, número de individuos, y hora del avistamiento. Estos datos se procesan y visualizan automáticamente en el mapa.
    </p>
  </div>

  <div class="section">
    <h2>Agregar nuevo avistamiento</h2>
    <form id="avistamientoForm">
      <input type="text" id="nombre" placeholder="Nombre del avistamiento" required />
      <input type="number" step="any" id="latitud" placeholder="Latitud" required />
      <input type="number" step="any" id="longitud" placeholder="Longitud" required />
      <input type="datetime-local" id="fecha_hora" required />
      <button type="submit">Enviar</button>
    </form>
    <p id="status"></p>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([-53.16, -70.88], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Hacer clic en el mapa y llenar el formulario
    map.on('click', function(e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      document.getElementById('latitud').value = lat;
      document.getElementById('longitud').value = lng;
    });

    async function cargarPuntos() {
      const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQEY7fBxtuNz4vRUlGQa3sLykz7j1szN9nntF7riNbSxGyMwDQFx4hrBozGDH3KYQ/pub?output=csv');
      const text = await response.text();
      const rows = text.trim().split('\n').slice(1);

      rows.forEach(row => {
        const [nombre, lat, lon, fecha] = row.split(',');
        if (!isNaN(lat) && !isNaN(lon)) {
          L.circleMarker([parseFloat(lat), parseFloat(lon)], {
            radius: 6,
            color: "red",
            fillColor: "red",
            fillOpacity: 0.9
          }).addTo(map)
            .bindPopup(`<b>${nombre}</b><br>${fecha}`);
        }
      });
    }

    cargarPuntos();

    const form = document.getElementById('avistamientoForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        nombre: document.getElementById('nombre').value,
        latitud: document.getElementById('latitud').value,
        longitud: document.getElementById('longitud').value,
        fecha_hora: document.getElementById('fecha_hora').value
      };
      const status = document.getElementById('status');
      status.textContent = "Enviando datos...";

      try {
        const res = await fetch("https://script.google.com/macros/s/AKfycbxU8ONChjOfqlqW1KcKvf0_BMU-8l5jKOCjZ7aQL_ypcjbzqBgUHm6rOmR9kcZGW2aIwg/exec", {
          method: "POST",
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.result === "success") {
          status.textContent = "Avistamiento enviado correctamente.";
          form.reset();
          map.eachLayer((layer) => {
            if (layer instanceof L.CircleMarker) map.removeLayer(layer);
          });
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
          cargarPuntos();
        } else {
          status.textContent = "Hubo un error al enviar.";
        }
      } catch (err) {
        status.textContent = "Error de conexión.";
      }
    });
  </script>

</body>
</html>
