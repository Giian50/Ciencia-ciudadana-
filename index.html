
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Ciencia Ciudadana</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial; margin: 0; padding: 0; }
    #map { height: 500px; }
    .section { padding: 20px; }
    iframe { width: 100%; max-width: 800px; height: 450px; display: block; margin: auto; }
    form { margin-top: 20px; }
    input, button { display: block; margin: 10px 0; padding: 8px; width: 300px; }
    .flex-container { display: flex; gap: 20px; flex-wrap: wrap; }
    .video-section, .image-section { flex: 1; min-width: 300px; }
    .image-section img { width: 100%; max-width: 400px; display: block; margin-bottom: 10px; }
  </style>
</head>
<body>

  <div class="section">
    <h1>Ciencia Ciudadana: Avistamientos</h1>
    <p>
      Este mapa interactivo muestra los puntos de avistamiento de cetáceos registrados en la Región de Magallanes.
      Cada marcador representa una observación con su respectiva especie, ubicación y fecha.
    </p>
    <div id="map"></div>
  </div>

  <div class="section">
    <h2>Agregar nuevo avistamiento</h2>
    <p>
      Para ingresar un nuevo dato, simplemente haga clic en el mapa para obtener la ubicación, luego complete el formulario con:
      nombre del avistamiento (especie), coordenadas (ya están autocompletadas) y la fecha/hora del avistamiento. Luego presione "Enviar".
    </p>
    <form id="avistamientoForm">
      <input type="text" id="nombre" placeholder="Nombre del avistamiento" required />
      <input type="number" step="any" id="latitud" placeholder="Latitud" required />
      <input type="number" step="any" id="longitud" placeholder="Longitud" required />
      <input type="datetime-local" id="fecha_hora" required />
      <button type="submit">Enviar</button>
    </form>
    <p id="status"></p>
  </div>

  <div class="section flex-container">
    <div class="video-section">
      <h2>Video Etiquetado con DeepLabCut</h2>
      <p>
        Este video muestra un ejemplo de etiquetado automático realizado con la plataforma DeepLabCut. Se pueden observar 3 delfines etiquetados
        dentro de un grupo de 7. Puedes pausar el video o avanzar cuadro a cuadro para identificar comportamientos
        como cópulas o patrones de movimiento individuales.
      </p>
      <iframe src="https://drive.google.com/file/d/1X3GRKkGTFH878GbsoCmc8_OyqnlDqXDe/preview" allow="autoplay"></iframe>
    </div>

    <div class="image-section">
      <img src="imagen1.jpg" alt="Gráfico 1 - Distribución" />
      <p><b>Gráfico 1:</b> Muestra la distribución espacial de los avistamientos a lo largo del estrecho de Magallanes.</p>

      <img src="imagen2.jpg" alt="Gráfico 2 - Frecuencia de especies" />
      <p><b>Gráfico 2:</b> Representa la frecuencia de avistamientos por especie, destacando el delfín austral.</p>

      <img src="imagen3.jpg" alt="Gráfico 3 - Horario de actividad" />
      <p><b>Gráfico 3:</b> Análisis de horario de actividad con mayor presencia de individuos observados.</p>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([-53.16, -70.88], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    map.on('click', function(e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      document.getElementById('latitud').value = lat;
      document.getElementById('longitud').value = lng;
    });

    async function cargarPuntos() {
      const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQEY7fBxtuNz4vRUlGQa3sLykz7j1szN9nntF7riNbSxGyMwDQFx4hrBozGDH3KYQ/pub?output=csv');
      const text = await response.text();
      const rows = text.trim().split('\n').slice(1);

      rows.forEach(row => {
        const [nombre, lat, lon, fecha] = row.split(',');
        if (!isNaN(lat) && !isNaN(lon)) {
          L.circleMarker([parseFloat(lat), parseFloat(lon)], {
            radius: 6,
            color: "red",
            fillColor: "red",
            fillOpacity: 0.9
          }).addTo(map)
            .bindPopup(`<b>${nombre}</b><br>${fecha}`);
        }
      });
    }

    cargarPuntos();

    const form = document.getElementById('avistamientoForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        nombre: document.getElementById('nombre').value,
        latitud: document.getElementById('latitud').value,
        longitud: document.getElementById('longitud').value,
        fecha_hora: document.getElementById('fecha_hora').value
      };
      const status = document.getElementById('status');
      status.textContent = "Enviando datos...";

      try {
        const res = await fetch("https://script.google.com/macros/s/AKfycbxU8ONChjOfqlqW1KcKvf0_BMU-8l5jKOCjZ7aQL_ypcjbzqBgUHm6rOmR9kcZGW2aIwg/exec", {
          method: "POST",
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.result === "success") {
          status.textContent = "Avistamiento enviado correctamente.";
          form.reset();
          map.eachLayer((layer) => {
            if (layer instanceof L.CircleMarker) map.removeLayer(layer);
          });
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
          cargarPuntos();
        } else {
          status.textContent = "Hubo un error al enviar.";
        }
      } catch (err) {
        status.textContent = "Error de conexión.";
      }
    });
  </script>

</body>
</html>
