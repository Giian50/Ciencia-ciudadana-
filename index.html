
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Ciencia Ciudadana</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .section { padding: 20px; }
    #map { height: 500px; width: 100%; }
    form { margin-top: 20px; }
    input, button { display: block; margin: 10px 0; padding: 8px; width: 300px; }
    iframe { width: 100%; max-width: 600px; height: 340px; border: none; }
    .flex-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: space-between;
    }
    .video-section, .image-section {
      flex: 1 1 300px;
    }
    .image-section img {
      width: 100%;
      max-width: 100%;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

  <div class="section">
    <h1>Mapas de cetáceos</h1>
    <p>
      <strong>Ayúdanos a construir el primer mapa ciudadano de cetáceos en la Patagonia</strong><br>
      Este mapa interactivo muestra los puntos de avistamiento de cetáceos registrados en la Región de Magallanes.
      Cada marcador representa una observación con su respectiva especie, ubicación y fecha.
      Cada avistamiento cuenta: comparte el tuyo y contribuye al conocimiento de nuestros océanos.
    </p>
    <div id="map"></div>
  </div>

  <div class="section">
    <h2>Agregar nuevo avistamiento</h2>
    <p>
      Previamente existiran talleres de conocimiento de levantamiento de informacion, encargados de capacitar a la ciudadnaia como poder ingresar datos y para que sirven el almacenamiento de ellos.
      Para ingresar un nuevo dato, haga clic en el mapa para obtener la ubicación y luego complete el formulario con:
      <strong>nombre del observador</strong> (Persona Natural, ong,comunidad,etc), coordenadas (autocompletadas) y la fecha/hora. seleccione la especie que observo y en observaciones cualquier comentatrio que obsevo en el cetaceo, soplos, saltos, etc  Luego presione "Enviar".
    </p>
    <form id="avistamientoForm">
      <input type="text" id="nombre" placeholder="Nombre del avistamiento" required />
      <input type="number" step="any" id="latitud" placeholder="Latitud" required />
      <input type="number" step="any" id="longitud" placeholder="Longitud" required />
      <input type="datetime-local" id="fecha_hora" required />
      <select name="especie" required>
  <option value="" disabled selected>Selecciona especie</option>
  <option value="Delfín austral">Delfín austral</option>
  <option value="Delfín chileno">Delfín chileno</option>
  <option value="Ballena">Ballena</option>
</select>

<textarea name="observaciones" rows="3" placeholder="Observaciones (comportamiento, grupo, etc.)"></textarea>

      <button type="submit">Enviar</button>
    </form>
    <p id="status"></p>
  </div>

  <div class="section">
    <h2>Registro audiovisual y análisis</h2>
    <div class="flex-container">
      <div class="video-section">
        <h3>Video etiquetado con DeepLabCut</h3>
        <p>
          En esta seccion se visualizaran los videos analizados recabados y enviados por la comunidad. 
          Este video muestra un ejemplo de etiquetado automático con DeepLabCut. Se observan 3 delfines etiquetados
          dentro de un grupo de 7. Puedes pausar o avanzar cuadro a cuadro para identificar comportamientos
          como cópulas o patrones de interacción.
        </p>
        <iframe src="https://drive.google.com/file/d/1X3GRKkGTFH878GbsoCmc8_OyqnlDqXDe/preview" allow="autoplay"></iframe>
      </div>

      <div class="video-section">
        <h3>Video georreferenciado desde dron</h3>
        <p>
          En esta seccion se observara el detalle de los analisis de cada individuo para asi tener un analisis personalziado de sus videos. 
          Este video fue capturado con dron e incluye datos GPS por cuadro. Está sincronizado con el video etiquetado para visualizar trayectorias de movimiento real de los delfines.
        </p>
       <iframe src="https://drive.google.com/file/d/1Me8-qx_sC1X68qVj7yEudrXQ8syjlcaV/preview" width="640" height="480" allow="autoplay"></iframe>

      </div>

      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([-53.16, -70.88], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    map.on('click', function(e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      document.getElementById('latitud').value = lat;
      document.getElementById('longitud').value = lng;
    });

    async function cargarPuntos() {
      const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQEY7fBxtuNz4vRUlGQa3sLykz7j1szN9nntF7riNbSxGyMwDQFx4hrBozGDH3KYQ/pub?output=csv');
      const text = await response.text();
      const rows = text.trim().split('\n').slice(1);

      rows.forEach(row => {
        const [nombre, lat, lon, fecha] = row.split(',');
        if (!isNaN(lat) && !isNaN(lon)) {
          L.circleMarker([parseFloat(lat), parseFloat(lon)], {
            radius: 6, color: "red", fillColor: "red", fillOpacity: 0.9
          }).addTo(map).bindPopup(`<b>${nombre}</b><br>${fecha}`);
        }
      });
    }

    cargarPuntos();

    document.getElementById('avistamientoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        nombre: document.getElementById('nombre').value,
        latitud: document.getElementById('latitud').value,
        longitud: document.getElementById('longitud').value,
        fecha_hora: document.getElementById('fecha_hora').value
      };
      const status = document.getElementById('status');
      status.textContent = "Enviando datos...";
      try {
        const res = await fetch("https://script.google.com/macros/s/AKfycbxU8ONChjOfqlqW1KcKvf0_BMU-8l5jKOCjZ7aQL_ypcjbzqBgUHm6rOmR9kcZGW2aIwg/exec", {
          method: "POST",
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.result === "success") {
          status.textContent = "Avistamiento enviado correctamente.";
          e.target.reset();
          map.eachLayer((layer) => {
            if (layer instanceof L.CircleMarker) map.removeLayer(layer);
          });
          cargarPuntos();
        } else {
          status.textContent = "Hubo un error al enviar.";
        }
      } catch {
        status.textContent = "Error de conexión.";
      }
    });
  </script>
</body>
</html>
